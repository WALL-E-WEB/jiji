"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[9469],{8146:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-3ed1db4b",path:"/study/15.%E7%A7%BB%E5%8A%A8%E7%AB%AF/%E5%B0%8F%E7%A8%8B%E5%BA%8F.html",title:"小程序优化",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"分包",slug:"分包",children:[{level:3,title:"包限制",slug:"包限制",children:[]},{level:3,title:"引用规则",slug:"引用规则",children:[]}]},{level:2,title:"分包分类",slug:"分包分类",children:[{level:3,title:"普通分包配置：",slug:"普通分包配置",children:[]},{level:3,title:"独立分包配置：",slug:"独立分包配置",children:[]}]},{level:2,title:"按需注入",slug:"按需注入",children:[]},{level:2,title:"多线程 Worker",slug:"多线程-worker",children:[]},{level:2,title:"Http数据缓存",slug:"http数据缓存",children:[{level:3,title:"数据预拉取",slug:"数据预拉取",children:[]},{level:3,title:"周期性更新",slug:"周期性更新",children:[]}]},{level:2,title:"生成骨架屏",slug:"生成骨架屏",children:[]},{level:2,title:"长列表优化",slug:"长列表优化",children:[]},{level:2,title:"预加载下个页面",slug:"预加载下个页面",children:[]},{level:2,title:"初始渲染缓存",slug:"初始渲染缓存",children:[]},{level:2,title:"安全区域兼容",slug:"安全区域兼容",children:[{level:3,title:"css",slug:"css",children:[]},{level:3,title:"getSystemInfo",slug:"getsysteminfo",children:[]}]},{level:2,title:"弱网监听提示",slug:"弱网监听提示",children:[]},{level:2,title:"createCacheManager",slug:"createcachemanager",children:[]}],filePathRelative:"study/15.移动端/小程序.md",git:{updatedTime:1669219461e3}}},5082:(n,s,a)=>{a.r(s),a.d(s,{default:()=>I});var e=a(6252);const p=(0,e.uE)('<h1 id="小程序优化" tabindex="-1"><a class="header-anchor" href="#小程序优化" aria-hidden="true">#</a> 小程序优化</h1><h2 id="分包" tabindex="-1"><a class="header-anchor" href="#分包" aria-hidden="true">#</a> 分包</h2><p>**小程序下包过程：**在小程序启动时，默认会下载主包并启动主包内页面，当用户进入分包内某个页面时，客户端会把对应分包下载下来，下载完成后再进行展示。</p><p>小程序划分成不同的子包，在构建时打包成不同的分包，用户在使用时按需进行加载。</p><p>对小程序进行分包，可以优化小程序首次启动的下载时间，</p><p>**主包：**即放置默认启动页面/TabBar 页面，以及一些所有分包都需用到公共资源/JS 脚本；</p><h3 id="包限制" tabindex="-1"><a class="header-anchor" href="#包限制" aria-hidden="true">#</a> 包限制</h3><p><strong>目前小程序分包大小有以下限制：</strong></p><ul><li>整个小程序所有分包大小不超过 20M</li><li>单个分包/主包大小不能超过 2M</li></ul><h3 id="引用规则" tabindex="-1"><a class="header-anchor" href="#引用规则" aria-hidden="true">#</a> 引用规则</h3><p><strong>分包引用规则：</strong></p>',11),t=(0,e._)("code",null,"packageA",-1),o=(0,e.Uk)(" 无法 require "),l=(0,e._)("code",null,"packageB",-1),c=(0,e.Uk)(" JS 文件，但可以 require 主包、"),r=(0,e._)("code",null,"packageA",-1),u=(0,e.Uk)(" 内的 JS 文件；使用 "),i={href:"https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages/async.html",target:"_blank",rel:"noopener noreferrer"},b=(0,e.Uk)("分包异步化"),k=(0,e.Uk)(" 时不受此条限制"),m=(0,e.uE)("<li><p><code>packageA</code> 无法 import <code>packageB</code> 的 template，但可以 require 主包、<code>packageA</code> 内的 template</p></li><li><p><code>packageA</code> 无法使用 <code>packageB</code> 的资源，但可以使用主包、<code>packageA</code> 内的资源</p></li>",2),d=(0,e.uE)('<h2 id="分包分类" tabindex="-1"><a class="header-anchor" href="#分包分类" aria-hidden="true">#</a> <strong>分包分类</strong></h2><ol><li>普通分包： <ul><li>子包可以引用主包资源；</li><li>进入子包或主包，都会下载主包；</li></ul></li><li>独立分包： <ul><li>子包不可以引用主包资源，完全独立；</li><li>进入独立子包，不会下载主包；</li></ul></li></ol><h3 id="普通分包配置" tabindex="-1"><a class="header-anchor" href="#普通分包配置" aria-hidden="true">#</a> 普通分包配置：</h3><p>https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages/basic.html</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>├── app.js\n├── app.json\n├── app.wxss\n├── packageA\n│   └── pages\n│       ├── cat\n│       └── dog\n├── packageB\n│   └── pages\n│       ├── apple\n│       └── banana\n├── pages\n│   ├── index\n│   └── logs\n└── utils\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span>\n    <span class="token string">&quot;pages/index&quot;</span><span class="token punctuation">,</span>\n    <span class="token string">&quot;pages/logs&quot;</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;subpackages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">&quot;root&quot;</span><span class="token operator">:</span> <span class="token string">&quot;packageA&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token string">&quot;pages/cat&quot;</span><span class="token punctuation">,</span>\n        <span class="token string">&quot;pages/dog&quot;</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      <span class="token property">&quot;root&quot;</span><span class="token operator">:</span> <span class="token string">&quot;packageB&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pack2&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token string">&quot;pages/apple&quot;</span><span class="token punctuation">,</span>\n        <span class="token string">&quot;pages/banana&quot;</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="独立分包配置" tabindex="-1"><a class="header-anchor" href="#独立分包配置" aria-hidden="true">#</a> 独立分包配置：</h3><p><code>subpackages</code>字段中对应的分包配置项中定义<code>independent</code>字段声明对应分包为独立分包。</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>├── app.js\n├── app.json\n├── app.wxss\n├── moduleA\n│   └── pages\n│       ├── rabbit\n│       └── squirrel\n├── moduleB\n│   └── pages\n│       ├── pear\n│       └── pineapple\n├── pages\n│   ├── index\n│   └── logs\n└── utils\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token string">&quot;pages/index&quot;</span><span class="token punctuation">,</span>\n    <span class="token string">&quot;pages/logs&quot;</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;subpackages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">&quot;root&quot;</span><span class="token operator">:</span> <span class="token string">&quot;moduleA&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token string">&quot;pages/rabbit&quot;</span><span class="token punctuation">,</span>\n        <span class="token string">&quot;pages/squirrel&quot;</span>\n      <span class="token punctuation">]</span>\n    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>\n      <span class="token property">&quot;root&quot;</span><span class="token operator">:</span> <span class="token string">&quot;moduleB&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;pages&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n        <span class="token string">&quot;pages/pear&quot;</span><span class="token punctuation">,</span>\n        <span class="token string">&quot;pages/pineapple&quot;</span>\n      <span class="token punctuation">]</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;independent&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="按需注入" tabindex="-1"><a class="header-anchor" href="#按需注入" aria-hidden="true">#</a> 按需注入</h2><p>微信小程序：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">/// app.json</span>\n<span class="token punctuation">{</span>\n  <span class="token comment">/// ... ...</span>\n  <span class="token property">&quot;lazyCodeLoading&quot;</span><span class="token operator">:</span> <span class="token string">&quot;requiredComponents&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>uniapp</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">/// manifest.json</span>\n<span class="token property">&quot;mp-weixin&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>\n\t<span class="token comment">/// ... ...</span>\n\t <span class="token property">&quot;lazyCodeLoading&quot;</span><span class="token operator">:</span> <span class="token string">&quot;requiredComponents&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="多线程-worker" tabindex="-1"><a class="header-anchor" href="#多线程-worker" aria-hidden="true">#</a> 多线程 Worker</h2><p>https://developers.weixin.qq.com/miniprogram/dev/framework/workers.html</p><h2 id="http数据缓存" tabindex="-1"><a class="header-anchor" href="#http数据缓存" aria-hidden="true">#</a> Http数据缓存</h2><h3 id="数据预拉取" tabindex="-1"><a class="header-anchor" href="#数据预拉取" aria-hidden="true">#</a> 数据预拉取</h3><p>官方文档：https://developers.weixin.qq.com/miniprogram/dev/framework/ability/pre-fetch.html</p><p>冷启动时执行请求，冷启动完成后，返回缓存数据；</p><p>预拉取能够在小程序冷启动的时候通过微信后台提前向第三方服务器拉取业务数据，当代码包加载完时可以更快地渲染页面，减少用户等待时间，从而提升小程序的打开速度 。</p><p>设置：登录小程序 MP 管理后台，进入开发管理 -&gt; 开发设置 -&gt; 数据预加载，点击开启，填写数据下载地址，只支持 HTTPS 。</p><p>使用：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code> wx<span class="token punctuation">.</span><span class="token function">setBackgroundFetchToken</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        token<span class="token operator">:</span> <span class="token string">&#39;weakNet&#39;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n wx<span class="token punctuation">.</span><span class="token function">getBackgroundFetchData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        fetchType<span class="token operator">:</span> <span class="token string">&#39;pre&#39;</span><span class="token punctuation">,</span>\n        <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            res<span class="token punctuation">.</span>fetchedData\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n           \n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token function">complete</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            \n        <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>当用户打开小程序时，微信服务器将向开发者服务器（上面配置的数据下载地址）发起一个 HTTP GET 请求，其中包含的 query 参数如下，数据获取到后会将整个 HTTP body 缓存到本地。</p><h3 id="周期性更新" tabindex="-1"><a class="header-anchor" href="#周期性更新" aria-hidden="true">#</a> 周期性更新</h3><p>官方文档：https://developers.weixin.qq.com/miniprogram/dev/framework/ability/background-fetch.html</p><p>每隔12 小时拉取一次；小程序启动后获取缓存；减少用户等待时间，增强在弱网条件下的可用性。</p><p>设置：登录小程序 MP 管理后台，进入开发管理 -&gt; 开发设置 -&gt; 数据周期性更新，点击开启，填写数据下载地址。</p><p>使用：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code> wx<span class="token punctuation">.</span><span class="token function">setBackgroundFetchToken</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        token<span class="token operator">:</span> <span class="token string">&#39;weakNet&#39;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n wx<span class="token punctuation">.</span><span class="token function">getBackgroundFetchData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n        fetchType<span class="token operator">:</span> <span class="token string">&#39;periodic&#39;</span><span class="token punctuation">,</span>\n        <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            res<span class="token punctuation">.</span>fetchedData\n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n           \n        <span class="token punctuation">}</span><span class="token punctuation">,</span>\n        <span class="token function">complete</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            \n        <span class="token punctuation">}</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="生成骨架屏" tabindex="-1"><a class="header-anchor" href="#生成骨架屏" aria-hidden="true">#</a> 生成骨架屏</h2><p>微信开发工具提供生成骨架屏的能力。</p><p>![image-20221120233020912](小程序.assets/image-20221120233020912.png<img src="小程序.assets/image-20221120234852949.png" alt="image-20221120234852949"></p><div class="language-html ext-html line-numbers-mode"><pre class="language-html"><code>/// 再使用的wxml页面引入\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>import</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index.skeleton.wxml<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">is</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>skeleton<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{{loading}}<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>\n\n/// wxss 中引入样式\n@import &quot;./index.skeleton.wxss&quot;;\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="长列表优化" tabindex="-1"><a class="header-anchor" href="#长列表优化" aria-hidden="true">#</a> 长列表优化</h2>',37),g=(0,e.Uk)("wx："),h={href:"https://developers.weixin.qq.com/miniprogram/dev/platform-capabilities/extended/component-plus/recycle-view.html",target:"_blank",rel:"noopener noreferrer"},v=(0,e.Uk)("recycle-view"),q=(0,e.Uk)("uniapp："),f={href:"https://uniapp.dcloud.net.cn/component/recycle-list.html#recycle-list",target:"_blank",rel:"noopener noreferrer"},x=(0,e.Uk)("recycle-list"),w=(0,e.uE)('<div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>recycle-view\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="预加载下个页面" tabindex="-1"><a class="header-anchor" href="#预加载下个页面" aria-hidden="true">#</a> 预加载下个页面</h2><p><code>handleWebviewPreload</code> 有以下取值</p>',3),y=(0,e._)("li",null,"static: 默认值。在当前页面 onReady 触发 200ms 后触发预加载。",-1),j=(0,e._)("li",null,"auto: 渲染线程空闲时进行预加载。由基础库根据一段时间内 requestAnimationFrame 的触发频率算法判断。",-1),_=(0,e.Uk)("manual: 由开发者通过调用 "),B={href:"https://developers.weixin.qq.com/miniprogram/dev/api/base/performance/wx.preloadWebview.html",target:"_blank",rel:"noopener noreferrer"},A=(0,e._)("code",null,"wx.preloadWebview",-1),C=(0,e.Uk)(" 触发。开发者可以在页面主要内容的 setData 结束后手动触发。"),H=(0,e.uE)('<div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">/// app.json</span>\n<span class="token punctuation">{</span>\n  <span class="token property">&quot;window&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">&quot;handleWebviewPreload&quot;</span><span class="token operator">:</span> <span class="token string">&quot;auto&quot;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">/// 单个页面</span>\n<span class="token punctuation">{</span>\n  <span class="token property">&quot;handleWebviewPreload&quot;</span><span class="token operator">:</span> <span class="token string">&quot;manual&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="初始渲染缓存" tabindex="-1"><a class="header-anchor" href="#初始渲染缓存" aria-hidden="true">#</a> 初始渲染缓存</h2>',3),W=(0,e.Uk)("文档："),E={href:"https://developers.weixin.qq.com/miniprogram/dev/framework/view/initial-rendering-cache.html",target:"_blank",rel:"noopener noreferrer"},U=(0,e.Uk)("官方文档"),R=(0,e.uE)('<p>启用初始渲染缓存，可以使视图层不需要等待逻辑层初始化完毕，而直接提前将页面初始 data 的渲染结果展示给用户，这可以使得页面对用户可见的时间大大提前。它的工作原理如下：</p><ul><li>在小程序页面第一次被打开后，将页面初始数据渲染结果记录下来，写入一个持久化的缓存区域（缓存可长时间保留，但可能因为小程序更新、基础库更新、储存空间回收等原因被清除）；</li><li>在这个页面被第二次打开时，检查缓存中是否还存有这个页面上一次初始数据的渲染结果，如果有，就直接将渲染结果展示出来；</li><li>如果展示了缓存中的渲染结果，这个页面暂时还不能响应用户事件，等到逻辑层初始化完毕后才能响应用户事件。</li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code>initialRenderingCache<span class="token operator">:</span> <span class="token string">&quot;static&quot;</span> <span class="token comment">// 初始化 data 中数据</span>\n\n\ninitialRenderingCache<span class="token operator">:</span> <span class="token string">&quot;dynamic&quot;</span> <span class="token comment">// 可使用setInitialRenderingCache初始化数据</span>\n\nthis.setInitialRenderingCache(<span class="token punctuation">{</span>\n      loadingHint<span class="token operator">:</span> &#39;正在加载&#39; <span class="token comment">// 这一部分数据将被应用于界面上，相当于在初始 data 基础上额外进行一次 setData</span>\n<span class="token punctuation">}</span>);\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>指定页面开启：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">/// 页面的 json 中</span>\n<span class="token punctuation">{</span>\n  <span class="token property">&quot;initialRenderingCache&quot;</span><span class="token operator">:</span> <span class="token string">&quot;static&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>全局开启：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;window&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">&quot;initialRenderingCache&quot;</span><span class="token operator">:</span> <span class="token string">&quot;static&quot;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="安全区域兼容" tabindex="-1"><a class="header-anchor" href="#安全区域兼容" aria-hidden="true">#</a> 安全区域兼容</h2><h3 id="css" tabindex="-1"><a class="header-anchor" href="#css" aria-hidden="true">#</a> css</h3><div class="language-css ext-css line-numbers-mode"><pre class="language-css"><code><span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">constant</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 兼容 IOS &lt; 11.2 */</span>\n<span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token function">env</span><span class="token punctuation">(</span>safe-area-inset-bottom<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 兼容 IOS &gt; 11.2 */</span>\n\n先使用 constant 后使用 env；\n\nsafe-area-inset-bottom  <span class="token comment">/* 底部安全距离 */</span>\nsafe-area-inset-top \t  <span class="token comment">/* 顶部安全距离 */</span>\nsafe-area-inset-left \t  <span class="token comment">/* 左边安全距离 */</span>\nsafe-area-inset-right   <span class="token comment">/* 右边安全距离 */</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="getsysteminfo" tabindex="-1"><a class="header-anchor" href="#getsysteminfo" aria-hidden="true">#</a> getSystemInfo</h3>',11),S={href:"https://developers.weixin.qq.com/miniprogram/dev/api/base/system/wx.getSystemInfoAsync.html",target:"_blank",rel:"noopener noreferrer"},T=(0,e.Uk)("getSystemInfoAsync"),M=(0,e.uE)('<div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code> wx<span class="token punctuation">.</span><span class="token function">getSystemInfoAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;result&#39;</span><span class="token punctuation">,</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">/// 获取底部安全区局域高度</span>\n        <span class="token keyword">const</span> safeBottomHeight <span class="token operator">=</span> result<span class="token punctuation">.</span>screenHeight <span class="token operator">-</span> result<span class="token punctuation">.</span>safeArea<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\nresult<span class="token operator">:</span><span class="token punctuation">{</span>\n  <span class="token comment">// ... ...</span>\n  platform<span class="token operator">:</span> <span class="token string">&quot;devtools&quot;</span><span class="token punctuation">,</span>\n  safeArea<span class="token operator">:</span><span class="token punctuation">{</span> <span class="token comment">// 在竖屏正方向下的安全区域</span>\n    bottom<span class="token operator">:</span> <span class="token number">862</span><span class="token punctuation">,</span> \n    height<span class="token operator">:</span> <span class="token number">818</span><span class="token punctuation">,</span>  <span class="token comment">// 安全区域的高度，单位逻辑像素</span>\n    left<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>\n    right<span class="token operator">:</span> <span class="token number">414</span><span class="token punctuation">,</span>\n    top<span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token comment">// 安全区域左上角纵坐标</span>\n    width<span class="token operator">:</span> <span class="token number">414</span><span class="token punctuation">,</span> <span class="token comment">// 安全区域的高度，单位逻辑像素</span>\n  <span class="token punctuation">}</span>\n  screenHeight<span class="token operator">:</span> <span class="token number">896</span><span class="token punctuation">,</span> <span class="token comment">// 屏幕高度</span>\n  screenWidth<span class="token operator">:</span> <span class="token number">414</span><span class="token punctuation">,</span>\n  statusBarHeight<span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span> <span class="token comment">// 状态栏的高度</span>\n  system<span class="token operator">:</span> <span class="token string">&quot;iOS 10.0.1&quot;</span><span class="token punctuation">,</span>\n  version<span class="token operator">:</span> <span class="token string">&quot;8.0.5&quot;</span><span class="token punctuation">,</span>\n  wifiEnabled<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>\n  windowHeight<span class="token operator">:</span> <span class="token number">808</span><span class="token punctuation">,</span> <span class="token comment">// 可使用窗口高度 = 屏幕高度 - statusBarHeight - 胶囊栏高度</span>\n  windowWidth<span class="token operator">:</span> <span class="token number">414</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">/// 获取导航栏高度</span>\n<span class="token keyword">const</span> navHeight <span class="token operator">=</span> screenHeight <span class="token operator">-</span> windowHeight <span class="token operator">-</span> statusBarHeight；\n\n<span class="token comment">/// 获取胶囊位置信息</span>\n<span class="token keyword">let</span> menuButton <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">getMenuButtonBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>；\nmenuButton<span class="token operator">:</span><span class="token punctuation">{</span>\n  bottom<span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span>\n  height<span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>\n  left<span class="token operator">:</span> <span class="token number">320</span><span class="token punctuation">,</span>\n  right<span class="token operator">:</span> <span class="token number">407</span><span class="token punctuation">,</span>\n  top<span class="token operator">:</span> <span class="token number">48</span><span class="token punctuation">,</span>\n  width<span class="token operator">:</span> <span class="token number">87</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h2 id="弱网监听提示" tabindex="-1"><a class="header-anchor" href="#弱网监听提示" aria-hidden="true">#</a> 弱网监听提示</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>wx<span class="token punctuation">.</span><span class="token function">onNetworkWeakChange</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>weakNet<span class="token punctuation">)</span> \t\t\t<span class="token comment">// 当前是否处于弱网状态</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>networkType<span class="token punctuation">)</span>\t<span class="token comment">// 当前网络类型</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="createcachemanager" tabindex="-1"><a class="header-anchor" href="#createcachemanager" aria-hidden="true">#</a> createCacheManager</h2><p>注意：目前暂时只有 iOS 端支持</p><p>小程序提供了一个无侵入式的缓存管理器，开发者可以不需要修改原有业务代码进行接入。缓存管理器主要有以下几个能力：</p><ul><li>在网络通畅时，对符合规则的网络请求进行缓存；在弱网时对该网络请求使用缓存返回。</li><li>在网络通畅时，对部分 wx api 调用进行缓存；在弱网时对这些 wx api 的调用使用缓存返回。</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 创建缓存管理器</span>\n<span class="token keyword">const</span> cacheManager <span class="token operator">=</span> wx<span class="token punctuation">.</span><span class="token function">createCacheManager</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  origin<span class="token operator">:</span> <span class="token string">&#39;https://weixin.qq.com/&#39;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 添加请求规则</span>\ncacheManager<span class="token punctuation">.</span><span class="token function">addRules</span><span class="token punctuation">(</span><span class="token punctuation">[</span>\n  <span class="token string">&#39;/cgi/home&#39;</span><span class="token punctuation">,</span>\n  <span class="token string">&#39;/cgi/detail/:id&#39;</span><span class="token punctuation">,</span>\n<span class="token punctuation">]</span><span class="token punctuation">)</span>\n\n<span class="token comment">// 监听符合规则的 wx.request 请求，默认在弱网时调用 wx.request 即会触发</span>\ncacheManager<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">,</span> <span class="token parameter">evt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 匹配是否存在缓存</span>\n    <span class="token keyword">const</span> matchRes <span class="token operator">=</span> cacheManager<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>matchRes <span class="token operator">&amp;&amp;</span> matchRes<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 使用缓存返回</span>\n      <span class="token function">resolve</span><span class="token punctuation">(</span>matchRes<span class="token punctuation">.</span>data<span class="token punctuation">)</span>\n    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>\n      <span class="token comment">// 没有匹配到缓存</span>\n      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>errMsg<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">catch not found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>evt<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div>',8),P={},I=(0,a(3744).Z)(P,[["render",function(n,s){const a=(0,e.up)("OutboundLink");return(0,e.wg)(),(0,e.iD)(e.HY,null,[p,(0,e._)("ul",null,[(0,e._)("li",null,[(0,e._)("p",null,[t,o,l,c,r,u,(0,e._)("a",i,[b,(0,e.Wm)(a)]),k])]),m]),d,(0,e._)("p",null,[g,(0,e._)("a",h,[v,(0,e.Wm)(a)])]),(0,e._)("p",null,[q,(0,e._)("a",f,[x,(0,e.Wm)(a)])]),w,(0,e._)("ul",null,[y,j,(0,e._)("li",null,[_,(0,e._)("a",B,[A,(0,e.Wm)(a)]),C])]),H,(0,e._)("p",null,[W,(0,e._)("a",E,[U,(0,e.Wm)(a)])]),R,(0,e._)("p",null,[(0,e._)("a",S,[T,(0,e.Wm)(a)])]),M],64)}]])},3744:(n,s)=>{s.Z=(n,s)=>{const a=n.__vccOpts||n;for(const[n,e]of s)a[n]=e;return a}}}]);